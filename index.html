<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>DestinCompass</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #form-screen, #map-screen { padding: 1em; }
    #map { height: 70vh; width: 100%; margin-top: 1em; }
    #fortune-display {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.8);
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 999;
    }
    #fortune-chart {
      max-width: 400px;
      margin: 0 auto;
    }
    #total-score {
      text-align: center;
      font-weight: bold;
      font-size: 1.2em;
      margin-top: 10px;
    }
    #ranking-list {
      margin-top: 20px;
      text-align: center;
    }
    #ranking-list ul {
      list-style: none;
      padding: 0;
    }
    #ranking-list li {
      margin: 4px 0;
    }
    #summary-chart {
      width: 300px;
      height: 300px;
    }
    /* CSSã«è¿½åŠ ï¼ˆå³ä¸Šã«å›ºå®šï¼‰ */
    #fortune-summary {
      display: none; /* â† ã“ã‚Œã‚’è¿½åŠ ï¼ */
      position: absolute;
      top: 10px;
      right: 10px;
      width: 320px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 10px;
      z-index: 1000;
      text-align: center;
      font-size: 0.9em;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      
    }

    @media screen and (max-width: 768px) {
      #summary-chart {
        display: none !important;
      }
    }
  </style>
</head>
<body>

<!-- â˜…â˜… å ã„ãƒ•ã‚©ãƒ¼ãƒ ç”»é¢ â˜…â˜… -->
<div id="form-screen">
  <h2>ğŸ”® ä»Šæ—¥ã®16æ–¹ä½é‹å‹¢ãƒãƒ£ãƒ¼ãƒˆ</h2>
  <label>æ˜Ÿåº§ã‚’é¸ã¶ï¼š
    <select id="zodiac">
      <option>ãŠã²ã¤ã˜åº§</option><option>ãŠã†ã—åº§</option><option>ãµãŸã”åº§</option>
      <option>ã‹ã«åº§</option><option>ã—ã—åº§</option><option>ãŠã¨ã‚åº§</option>
      <option>ã¦ã‚“ã³ã‚“åº§</option><option>ã•ãã‚Šåº§</option><option>ã„ã¦åº§</option>
      <option>ã‚„ãåº§</option><option>ã¿ãšãŒã‚åº§</option><option>ã†ãŠåº§</option>
    </select>
  </label>
  <button onclick="showFullFortuneChart()">è¡¨ç¤º</button>
  <canvas id="fortune-chart" width="350" height="350"></canvas><br>
  <div id="total-score"></div><br>
  <div id="ranking-list"></div>
  <div id="daily-walk-summary"></div>
  <button onclick="startFortune()">åœ°å›³ã¸ â†’</button>
</div>

<!-- â˜…â˜… åœ°å›³è¡¨ç¤ºç”»é¢ â˜…â˜… -->
<div id="map-screen" style="display:none;">
  <!-- åœ°å›³ç”»é¢ã«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆ#map-screenå†…ã®ä¸‹ã§OKï¼‰ -->
  <button id="toggle-chart-btn" style="position:absolute; top:10px; right:10px; z-index:1001;">
    ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º/éè¡¨ç¤º
  </button>
  <!-- åœ°å›³ç”»é¢ï¼ˆ#map-screenï¼‰å†…ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
  <button id="back-to-form-btn" style="position:absolute; top:10px; left:10px; z-index:1001;">
    â† æˆ»ã‚‹
  </button>

  <div id="map"></div>
  <div id="fortune-display"></div>
  <div id="fortune-summary">
    <div id="summary-zodiac"></div>
    <canvas id="summary-chart" width="300" height="300"></canvas>
    <div id="summary-score"></div>
  </div>
</div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map, marker, line, path = [], watchId;
let baseRank = 1, extraBoost = 0;
let zodiacGlobal = "", directionGlobal = "";
let fortuneChart;
let summaryChart;
const directionLabels = ["åŒ—", "åŒ—åŒ—æ±", "åŒ—æ±", "æ±åŒ—æ±", "æ±", "æ±å—æ±", "å—æ±", "å—å—æ±", "å—", "å—å—è¥¿", "å—è¥¿", "è¥¿å—è¥¿", "è¥¿", "è¥¿åŒ—è¥¿", "åŒ—è¥¿", "åŒ—åŒ—è¥¿"];
const zodiacList = ["ãŠã²ã¤ã˜åº§", "ãŠã†ã—åº§", "ãµãŸã”åº§", "ã‹ã«åº§", "ã—ã—åº§", "ãŠã¨ã‚åº§", "ã¦ã‚“ã³ã‚“åº§", "ã•ãã‚Šåº§", "ã„ã¦åº§", "ã‚„ãåº§", "ã¿ãšãŒã‚åº§", "ã†ãŠåº§"];

function showSummaryChart(zodiac, dateStr) {
  const ranks = directionLabels.map(dir => getFortuneRank(zodiac, dir, dateStr));
  const total = ranks.reduce((a, b) => a + b, 0);

  document.getElementById("summary-zodiac").textContent = `ğŸŒŸ ${zodiac}`;
  document.getElementById("summary-score").textContent = `é‹æ°—åˆè¨ˆï¼š${total} / 192`;

  const ctx = document.getElementById("summary-chart").getContext("2d");

  if (summaryChart) summaryChart.destroy(); // å‰ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„

  summaryChart = new Chart(ctx, {
    type: 'polarArea',
    data: {
      labels: directionLabels,
      datasets: [{
        label: 'é‹å‹¢',
        data: ranks,
        backgroundColor: ranks.map(rank => `rgba(${255 - rank * 10}, ${100 + rank * 10}, 200, 0.6)`),
      }]
    },
    options: {
      scales: { r: { suggestedMin: 0, suggestedMax: 12, ticks: { stepSize: 1 } } },
      plugins: { legend: { display: false } }
    }
  });
}

function getScoreDelta(rank) {
  if (rank >= 9) return 1;
  if (rank <= 4) return -1;
  return 0;
}

function bearingToDirection(bearing) {
  const directions = directionLabels;
  const adjusted = (bearing + 360 + 11.25) % 360; // ä¸­å¤®è§’ã§åˆ‡ã‚Šæ›¿ãˆ
  const index = Math.floor(adjusted / 22.5) % 16;
  return directions[index];
}

function calculateBearing(from, to) {
  const fromPoint = turf.point(from);
  const toPoint = turf.point(to);
  return turf.bearing(fromPoint, toPoint); // -180ã€œ180Â°
}


function hashString(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = (hash << 5) - hash + str.charCodeAt(i);
    hash |= 0;
  }
  return Math.abs(hash);
}

function getFortuneRank(zodiac, direction, dateStr) {
  const key = zodiac + direction + dateStr;
  const hash = hashString(key);
  return (hash % 12) + 1;
}

function showFullFortuneChart() {
  const selectedZodiac = document.getElementById("zodiac").value;
  const today = new Date().toISOString().slice(0, 10);
  const ranks = directionLabels.map(dir => getFortuneRank(selectedZodiac, dir, today));
  const total = ranks.reduce((a, b) => a + b, 0);

  const ctx = document.getElementById("fortune-chart").getContext("2d");
  new Chart(ctx, {
    type: 'polarArea',
    data: {
      labels: directionLabels,
      datasets: [{
        label: 'é‹å‹¢ãƒ©ãƒ³ã‚¯',
        data: ranks,
        backgroundColor: ranks.map(rank => `rgba(${255 - rank * 10}, ${100 + rank * 10}, 200, 0.7)`),
      }]
    },
    options: {
      scales: { r: { suggestedMin: 0, suggestedMax: 12, ticks: { stepSize: 1 } } },
      plugins: { legend: { position: 'right' } }
    }
  });

  document.getElementById("total-score").textContent = `ã‚ãªãŸã®æœ¬æ—¥ã®é‹æ°—åˆè¨ˆã‚¹ã‚³ã‚¢ï¼š${total} / 192`;

  // å…¨æ˜Ÿåº§ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
  const ranking = zodiacList.map(z => {
    const score = directionLabels.map(dir => getFortuneRank(z, dir, today)).reduce((a, b) => a + b, 0);
    return { zodiac: z, score: score };
  }).sort((a, b) => b.score - a.score);

  const rankingHtml = `<h3>ğŸ”¢ å…¨æ˜Ÿåº§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆé‹æ°—ã‚¹ã‚³ã‚¢ï¼‰</h3><ul>` +
    ranking.map((item, index) => `<li>${index + 1}ä½ï¼š${item.zodiac}ï¼ˆ${item.score}ç‚¹ï¼‰</li>`).join('') +
    `</ul>`;

  document.getElementById("ranking-list").innerHTML = rankingHtml;
}

function updateFortuneDisplay() {/*
  const total = Math.min(12, baseRank + extraBoost);
  document.getElementById("fortune-display").innerHTML =
    `${zodiacGlobal} Ã— ${directionGlobal}<br>é‹å‹¢ãƒ©ãƒ³ã‚¯ï¼š<strong>${total}</strong> / 12<br>` +
    `ï¼ˆãƒ™ãƒ¼ã‚¹ï¼š${baseRank} + ç§»å‹•è£œæ­£ï¼š${extraBoost}ï¼‰`;*/
}

function startFortune() {
  zodiacGlobal = document.getElementById("zodiac").value;
  directionGlobal = "é¸æŠãªã—";
  const today = new Date().toISOString().slice(0, 10);
  baseRank = 6;
  extraBoost = 0;

  updateFortuneDisplay();
  document.getElementById("form-screen").style.display = "none";
  document.getElementById("map-screen").style.display = "block";

  // â† ã“ã“ã§å³ä¸Šã®è¡¨ç¤ºã‚’æœ‰åŠ¹ã«ã™ã‚‹ï¼
  document.getElementById("fortune-summary").style.display = "block";
  
  // æ˜Ÿåº§ãƒ»ãƒãƒ£ãƒ¼ãƒˆãƒ»ã‚¹ã‚³ã‚¢ã‚’å³ä¸Šã«è¡¨ç¤º
  showSummaryChart(zodiacGlobal, today);

  if (!navigator.geolocation) {
    alert("ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“");
    return;
  }

  watchId = navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const point = [lng, lat];
      path.push(point);

      if (!map) {
        map = L.map('map').setView([lat, lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
      }

      if (!marker) {
        marker = L.marker([lat, lng]).addTo(map).bindPopup("ç¾åœ¨åœ°").openPopup();
      } else {
        marker.setLatLng([lat, lng]);
      }

      if (line) {
        map.removeLayer(line);
      }

      const latlngs = path.map(p => [p[1], p[0]]);
      line = L.polyline(latlngs, { color: 'blue' }).addTo(map);

      if (path.length >= 2) {
        const lineString = turf.lineString(path);
        const distKm = turf.length(lineString);
        const distM = Math.round(distKm * 1000);
        extraBoost = Math.min(3, Math.floor(distM / 100));
        updateFortuneDisplay();
      }
      if (path.length >= 2) {
        const prev = path[path.length - 2];
        const curr = path[path.length - 1];

        // æ–¹ä½è¨ˆç®—
        const bearing = calculateBearing(prev, curr); // -180ã€œ180
        const angle = (bearing + 360) % 360; // 0ã€œ360ã«æ­£è¦åŒ–
        const direction = bearingToDirection(angle);

        directionGlobal = direction;

        const today = new Date().toISOString().slice(0, 10);
        const rank = getFortuneRank(zodiacGlobal, direction, today);
        baseRank += getScoreDelta(rank);
        baseRank = Math.max(0, Math.min(12, baseRank)); // ç¯„å›²åˆ¶é™

        // è·é›¢ã«ã‚ˆã‚‹ extraBoost ã¯ãã®ã¾ã¾ç¶™ç¶š
        const lineString = turf.lineString(path);
        const distKm = turf.length(lineString);
        const distM = Math.round(distKm * 1000);
        extraBoost = Math.min(3, Math.floor(distM / 100));

        updateFortuneDisplay();
      }

    },
    (err) => {
      alert("ä½ç½®å–å¾—ã‚¨ãƒ©ãƒ¼: " + err.message);
    },
    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
    
  );
}

function saveDailyWalkData(direction, distance) {
  const today = new Date().toISOString().slice(0, 10); // e.g. "2025-07-03"
  let logs = JSON.parse(localStorage.getItem("dailyWalkLogs") || "{}");

  if (!logs[today]) logs[today] = {};
  if (!logs[today][direction]) logs[today][direction] = 0;

  logs[today][direction] += distance;

  localStorage.setItem("dailyWalkLogs", JSON.stringify(logs));
}


// ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
document.getElementById("toggle-chart-btn").addEventListener("click", () => {
  const chart = document.getElementById("summary-chart");
  const style = window.getComputedStyle(chart);

  // ã‚¹ãƒãƒ›ã§CSSãŒéè¡¨ç¤ºã«ãªã£ã¦ã„ã‚‹å ´åˆã¯å¼·åˆ¶çš„ã«è¡¨ç¤ºä¸å¯
  if (window.innerWidth <= 768) {
    alert("ã‚¹ãƒãƒ›è¡¨ç¤ºã§ã¯ãƒãƒ£ãƒ¼ãƒˆã¯éè¡¨ç¤ºã§ã™");
    return;
  }

  // PCç­‰ã®å ´åˆã¯è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
  if (style.display === "none") {
    chart.style.display = "block";
  } else {
    chart.style.display = "none";
  }
});
function displayTodayWalkSummary() {
  const today = new Date().toISOString().slice(0, 10);
  const logs = JSON.parse(localStorage.getItem("dailyWalkLogs") || "{}");
  const todayData = logs[today] || {};

  if (Object.keys(todayData).length === 0) {
    document.getElementById("daily-walk-summary").innerHTML = "ä»Šæ—¥ã®æ­©è¡Œè¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  let html = "<h3>ğŸš¶â€â™‚ï¸ ä»Šæ—¥ã®æ–¹è§’åˆ¥ æ­©è¡Œè·é›¢</h3><ul>";
  for (const [direction, distance] of Object.entries(todayData)) {
    html += `<li>${direction}ï¼š${Math.round(distance)} m</li>`;
  }
  html += "</ul>";

  document.getElementById("daily-walk-summary").innerHTML = html;
}

document.getElementById("back-to-form-btn").addEventListener("click", () => {
  // åœ°å›³ç”»é¢ã‚’éè¡¨ç¤ºã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’å†è¡¨ç¤º
  document.getElementById("map-screen").style.display = "none";
  document.getElementById("form-screen").style.display = "block";

  // ä½ç½®æƒ…å ±ã®è¿½è·¡ã‚’æ­¢ã‚ã‚‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
  if (watchId) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }

  // ãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãªã©ã¯ãã®ã¾ã¾æ®‹ã—ã¦ãŠã‘ã°å†é–‹ã‚‚å¯èƒ½
});
// ãŸã¨ãˆã°æ–¹å‘ãŒåˆ¤æ˜ã—ãŸã‚ã¨
const distance = distM - previousDistM; // å‰å›ã¨ã®å·®åˆ†ï¼ˆæ­©ã„ãŸåˆ†ï¼‰
if (distance > 0 && distance < 500) {  // æ€¥ãªã‚¸ãƒ£ãƒ³ãƒ—ã‚’é˜²ã
  saveDailyWalkData(direction, distance);
}
window.addEventListener("DOMContentLoaded", () => {
  displayTodayWalkSummary(); // â† ã“ã‚Œã‚’è¿½åŠ 
});

</script>
</body>
</html>
